# springcloud

### **认识微服务**

微服务是一种经过良好架构设计的**分布式**架构方案，微服务架构特征：

1. 单一职责：微服务拆分粒度更小，每一个服务都对应唯一的业务能力，做到单一职责，避免重复业务开发
2. 面向服务：微服务对外暴露业务接口
3. 自治：团队独立、技术独立、数据独立、部署独立
4. 隔离性强：服务调用做好隔离、容错、降级，避免出现级联问题

微服务调用方式：基于RestTemplate发起的http请求实现远程调用、http请求做远程调用是与语言无关的调用，只要知道对方的ip、端口、接口路径、请求参数即可

### **Eureka注册中心**

- Eureka的作用：

  1.消费者该如何获取服务提供者具体信息？

  ​	服务提供者启动时向eureka注册自己的信息

  ​	ueureka保存这些信息

  ​	消费者根据服务名称向eureka拉取提供者信息

  2.如果有多个服务提供者，消费者该如何选择？

  ​	服务消费者利用负载均衡算法，从服务列表中挑选一个

  ​	消费者如何感知服务提供者健康状态？

  ​	服务提供者会每隔30秒向EurekaServer发送心跳请求，报告健康状态

  3.ueureka会更新记录服务列表信息，心跳不正常会被剔除

  ​	消费者就可以拉取到最新的信息

### **Ribbon负载均衡**

懒加载：Ribbon默认是采用懒加载，即第一次访问时才会去创建LoadBalanceClient，请求时间会很长。

饥饿加载：饥饿加载则会在项目启动时创建，降低第一次访问的耗时

1.Ribbon负载均衡规则

​	规则接口是IRule

​	默认实现是ZoneAvoidanceRule，根据zone选择服务列表，然后轮询

2.负载均衡自定义方式

​	代码方式：配置灵活，但修改时需要重新打包发布

​	配置方式：直观，方便，无需重新打包发布，但是无法做全局配置

3.饥饿加载

​	开启饥饿加载    （在项目执行完那一刻就开始加载，提高了加载速度）

​	指定饥饿加载的微服务名称

### **Nacos注册中心**

#### **nacos服务分级存储模型**

#### **服务跨集群调用问题**

​	服务调用尽可能选择本地集群的服务，跨集群调用延迟较高

​	本地集群不可访问时，再去访问其它集群

#### **根据权重负载均衡**

​	服务器设备性能有差异，部分实例所在机器性能较好，另一些较差，我们希望性能好的机器承担更多的用户请求

​	Nacos提供了权重配置来控制访问频率，权重越大则访问频率越高

#### **实例的权重控制**

​	①Nacos控制台可以设置实例的权重值，0~1之间

​	②同集群内的多个实例，权重越高被访问的频率越高

​	③权重设置为0则完全不会被访问

#### **环境隔离** **- namespace**

​	每个namespace都有唯一id

​	服务设置namespace时要写id而不是名称

​	不同namespace下的服务互相不可见

#### **临时实例和非临时实例**

​	临时实例宕机时，会从nacos的服务列表中剔除，而非临时实例则不会

#### **Nacos与eureka的共同点**

​	都支持服务注册和服务拉取

​	都支持服务提供者心跳方式做健康检测

#### **Nacos与Eureka的区别**

​	Nacos支持服务端主动检测提供者状态：临时实例采用心跳模式，非临时实例采用主动检测模式

​	**临时实例心跳不正常会被剔除，非临时实例则不会被剔除**

​	**Nacos支持服务列表变更的消息推送模式，服务列表更新更及时**

​	Nacos集群默认采用AP方式，当集群中存在非临时实例时，采用CP模式；Eureka采用AP方式

### **Nacos配置管理**

### **http客户端Feign**

### **统一网关**Gateway

#### 网关功能

​	身份认证和权限校验

​	服务路由、负载均衡

​	请求限流

#### 网关的作用

​	对用户请求做身份认证、权限校验

​	将用户请求路由到微服务，并实现负载均衡

​	对用户请求做限流

#### **统一网关Gateway-路由断言工厂**

PredicateFactory的作用是什么

​	读取用户定义的断言条件，对请求做出判断

Path=/user/**是什么含义

​	路径是以/user开头的就认为是符合的

#### **各种过滤器**

**路由过滤器** **GatewayFilter**

​	普通配置过滤器的作用是什么

​		对路由的请求或响应做加工处理，比如添加请求头

​		配置在路由下的过滤器只对当前路由的请求生效

defaultFilters的作用是什么

​	对所有路由都生效的过滤器

**全局过滤器** GlobalFilter

​	全局过滤器的作用也是处理一切进入网关的请求和微服务响应，与GatewayFilter的作用一样

​	区别在于GatewayFilter通过配置定义，处理逻辑是固定的。而GlobalFilter的逻辑需要自己写代码实现

​	定义方式是实现GlobalFilter接口

**全局过滤器的作用是什么？**

​	对所有路由都生效的过滤器，并且可以自定义处理逻辑

**实现全局过滤器的步骤**？

​	实现GlobalFilter接口

​	添加@Order注解或实现Ordered接口

​	编写处理逻辑

**过滤器执行顺序**

​	每一个过滤器都必须指定一个int类型的order值，**order****值越小，优先级越高，执行顺序越靠前。**

​	GlobalFilter通过实现Ordered接口，或者添加@Order注解来指定order值，由我们自己指定

​	路由过滤器和defaultFilter的order由Spring指定，默认是按照声明顺序从1递增。

​	当过滤器的order值一样时，会按照 defaultFilter > 路由过滤器 > GlobalFilter的顺序执行。

#### **跨域问题处理**

​	跨域：域名不一致就是跨域，主要包括：

​		域名不同： :www.taobao.com 和 www.taobao.org 和 www.jd.com 和 miaosha.jd.com

​		域名相同，端口不同：localhost8080和localhost8081

​	跨域问题：浏览器禁止请求的发起者与服务端发生跨域ajax请求，请求被浏览器拦截的问题

​	解决方案：CORS

### Docker

#### **项目部署的问题**

​	大型项目组件较多，运行环境也较为复杂，部署时会碰到一些问题：

​		依赖关系复杂，容易出现兼容性问题

​		开发、测试、生产环境有差异

​	**Docker如何解决依赖的兼容问题的**

​		将应用的Libs（函数库）、Deps（依赖）、配置与应用一起打包

​		将每个应用放到一个隔离**容器**去运行，避免互相干扰

​	**Docker如何解决大型项目依赖关系复杂，不同组件依赖的兼容性问题**

​		Docker允许开发中将应用、依赖、函数库、配置一起**打包**，形成可移植镜像

​		Docker应用运行在容器中，使用沙箱机制，相互**隔离**

​	**Docker如何解决开发、测试、生产环境有差异的问题**

​		Docker镜像中包含完整运行环境，包括系统函数库，仅依赖系统的Linux内核，因此可以在任意Linux操作系统上运行

​	**Docker是一个快速交付应用、运行应用的技术：**

​		可以将程序及其依赖、运行环境一起打包为一个镜像，可以迁移到任意Linux操作系统

​		运行时利用沙箱机制形成隔离容器，各个应用互不干扰

​		启动、移除都可以通过一行命令完成，方便快捷

​	**Docker和虚拟机的差异：**

​		docker是一个系统进程；虚拟机是在操作系统中的操作系统

​		docker体积小、启动速度快、性能好；虚拟机体积大、启动速度慢、性能一般

### **MQ**

​	**同步调用存在的问题**

​		耦合度高

​		性能和吞吐能力下降

​		有额外的资源消耗

​		有级联失败问题

​	**同步调用的优点**

​		时效性较强，可以立即得到结果

​	**异步通信的优点**

​		耦合度低

​		吞吐量提升

​		故障隔离

​		流量削峰

​	**异步通信的缺点**

​		依赖于Broker的可靠性、安全性、吞吐能力

​		架构复杂了，业务没有明显的流程线，不好追踪管理

​	**什么是MQ**

​		MQ （MessageQueue），中文是消息队列，字面来看就是存放消息的队列。也就是事件驱动架构中的Broker

​	**RabbitMQ中的几个概念**

​		channel：操作MQ的工具

​		exchange：路由消息到队列中

​		queue：缓存消息

​		virtual host：虚拟主机，是对queue、exchange等资源的逻辑分组

​	**常见的交换机类型**

​		Fanout：广播

​		Direct：路由

​		Topic：话题

​	**交换机的作用是什么**

​		接收publisher发送的消息

​		将消息按照规则路由到与之绑定的队列

​		不能缓存消息，路由失败，消息丢失

​		FanoutExchange的会将消息路由到每个绑定的队列

​	**声明队列、交换机、绑定关系的Bean是什么**

​		Queue

​		FanoutExchange

​		Binding

​	**描述下Direct交换机与Fanout交换机的差异**

​		Fanout交换机将消息路由给每一个与之绑定的队列

​		Direct交换机根据RoutingKey判断路由给哪个队列

​		如果多个队列具有相同的RoutingKey，则与Fanout功能类似

​	**基于@RabbitListener注解声明队列和交换机有哪些常见注解**

​		@Queue

​		@Exchange

​	**描述下Direct交换机与Topic交换机的差异**

​		Topic交换机接收的消息RoutingKey必须是多个单词，以 **.** 分割

​		Topic交换机与队列绑定时的bindingKey可以指定通配符

​		#：代表0个或多个词

​		*：代表1个词

​	**SpringAMQP中消息的序列化和反序列化是怎么实现的**

​		利用MessageConverter实现的，默认是JDK的序列化(建议使用json)

​		注意发送方与接收方必须使用相同的MessageConverter	

### **分布式搜索引擎**

​	**elasticsearch基础**

​	**什么是elasticsearch**

​		一个开源的分布式搜索引擎，可以用来实现搜索、日志统计、分析、系统监控等功能

​	**什么是elastic stack（ELK）**

​		l是以elasticsearch为核心的技术栈，包括beats、Logstash、kibana、elasticsearch

​	**什么是Lucene**

​		是Apache的开源搜索引擎类库，提供了搜索引擎的核心API

​	**什么是文档和词条**

​		每一条数据就是一个文档

​		对文档中的内容分词，得到的词语就是词条

​	**什么是正向索引**

​		基于文档id创建索引。查询词条时必须先找到文档，而后判断是否包含词条

​	**什么是倒排索引**

​		对文档内容分词，对词条创建索引，并记录词条所在文档的信息。查询时先根据词条查询到文档id，而后获取到文档

​	**分词器的作用是什么**

​		•创建倒排索引时对文档分词

​		•用户搜索时，对输入的内容分词

​	**IK分词器有几种模式**

​		ik_smart：智能切分，粗粒度

​		ik_max_word：最细切分，细粒度

​	**IK分词器如何拓展词条？如何停用词条**

​		利用config目录的IkAnalyzer.cfg.xml文件添加拓展词典和停用词典

​		在词典中添加拓展词条或者停用词条

​	**mapping常见属性有哪些**

​		•type：数据类型

​		•index：是否索引

​		•analyzer：分词器

​		•properties：子字段

​	**type常见的有哪些**

​		•字符串：text、keyword

​		•数字：long、integer、short、byte、double、float

​		•布尔：boolean

​		•日期：date

​		•对象：object

​	**文档操作有哪些**

​		•创建文档：POST /索引库名/_doc/文档id { json文档 }

​		•查询文档：GET /索引库名/_doc/文档id

​		•删除文档：DELETE /索引库名/_doc/文档id

​		•修改文档：

​		•全量修改：PUT /索引库名/_doc/文档id { json文档 }

​		•增量修改：POST /索引库名/_update/文档id { "doc": {字段}}
